<!doctype html>
<html lang="vi"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>QR Factory V4 â€” Login/Outlogin QR</title>
<link rel="stylesheet" href="./shared.css"/>
<style>
.toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
.toolbar .left{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.qrbox{border:2px dashed #1e3566;border-radius:18px;min-height:260px;display:flex;align-items:center;justify-content:center;background:#071733}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
@media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
</style>
</head>
<body>
<div class="wrap">
  <div class="card" style="margin-bottom:14px">
    <div class="toolbar">
      <div class="left">
        <span class="pill">ğŸ QR Factory V4</span>
        <a href="./index.html">Generate</a>
        <a href="./dashboard.html">Dashboard</a>
        <a href="./customers.html">KhÃ¡ch hÃ ng</a>
        <a href="./staff.html">NhÃ¢n viÃªn quáº£n lÃ½</a>
        <a href="./login-qr.html"><b>Login/Outlogin QR</b></a>
        <a href="./admin.html">Admin</a>
      </div>
      <div class="left">
        <button class="btn secondary" id="btnReload">â†» Náº¡p cáº¥u hÃ¬nh</button>
      </div>
    </div>
    <div class="muted" style="margin-top:8px">Táº¡o QR Ä‘á»ƒ <b>Ä‘Äƒng nháº­p/Ä‘Äƒng xuáº¥t</b> (demo) báº±ng cÃ¡ch quÃ©t trÃªn Ä‘iá»‡n thoáº¡i. Admin cÃ³ thá»ƒ Ä‘á»•i <b>admin code</b> vÃ  <b>link cÃ i app</b>.</div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Cáº¥u hÃ¬nh admin</h2>
      <label>Admin code hiá»‡n táº¡i</label>
      <input id="admin_code" class="mono" placeholder="Nháº­p admin code"/>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnSetAdmin">ğŸ” Äá»•i admin code</button>
        <input id="new_admin_code" class="mono" placeholder="(tuá»³ chá»n) admin code má»›i" style="flex:1"/>
      </div>

      <label style="margin-top:14px">Link cÃ i app (APK/Store)</label>
      <input id="app_install_url" placeholder="https://..."/>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnSetUrl">ğŸ“¦ LÆ°u link cÃ i app</button>
      </div>

      <div id="msg" class="ok"></div>
      <div id="err" class="err"></div>
    </div>

    <div class="card">
      <h2>QR cÃ i app + táº¡o token Login/Outlogin</h2>
      <div class="row" style="margin-bottom:10px">
        <span class="pill">Install URL: <b id="outInstall">-</b></span>
      </div>
      <div class="qrbox" id="installBox">QR Install</div>

      <hr style="border:none;border-top:1px solid var(--line);margin:14px 0"/>

      <label>TTL token (phÃºt)</label>
      <input id="ttl" placeholder="10"/>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnLogin">âœ… Táº¡o Login QR</button>
        <button class="btn danger" id="btnLogout">â›” Táº¡o Outlogin QR</button>
      </div>

      <div class="row" style="margin-top:10px">
        <span class="pill">Token: <b id="outToken" class="mono">-</b></span>
        <span class="pill">URL: <b id="outUrl" class="mono">-</b></span>
      </div>
      <div class="qrbox" id="tokenBox">QR Token</div>
      <div class="muted" style="margin-top:10px">Äiá»‡n thoáº¡i quÃ©t QR Token â†’ gá»i API <span class="mono">/api/auth/consume</span> Ä‘á»ƒ nháº­n action (login/logout). ÄÃ¢y lÃ  flow demo Ä‘á»ƒ báº¡n tÃ­ch há»£p vÃ o app tháº­t.</div>
    </div>
  </div>
</div>

<script src="./qrFactoryV3.js"></script>
<script>
const $=id=>document.getElementById(id);

function setErr(e){ $("err").textContent = e? (e.message||String(e)) : ""; }
function setMsg(t){ $("msg").textContent = t||""; }

function renderQrText(boxId, text){
  const box = $(boxId);
  box.innerHTML = "";
  if(!text){ box.textContent = "-"; return; }
  const url = `/api/qrtext/png?text=${encodeURIComponent(text)}&ts=${Date.now()}`;
  const img = new Image();
  img.src = url;
  img.alt = "QR";
  box.appendChild(img);
}

async function loadPublic(){
  const r = await window.qrFactoryV3.apiGet("/api/auth/public");
  // Autofill current admin code for desktop demo so buttons work out-of-the-box.
  if(r.admin_code) $("admin_code").value = r.admin_code;
  $("outInstall").textContent = r.app_install_url || "-";
  $("app_install_url").value = r.app_install_url || "";
  renderQrText("installBox", r.app_install_url || "");
}

async function setAdminCode(){
  setErr(""); setMsg("");
  const admin_code = $("admin_code").value;
  const new_code = $("new_admin_code").value;
  const r = await window.qrFactoryV3.apiPost("/api/auth/setAdminCode", { admin_code, new_admin_code: new_code });
  $("admin_code").value = r.admin_code;
  $("new_admin_code").value = "";
  setMsg("ÄÃ£ Ä‘á»•i admin code.");
}

async function setInstallUrl(){
  setErr(""); setMsg("");
  const admin_code = $("admin_code").value;
  const app_install_url = $("app_install_url").value;
  const r = await window.qrFactoryV3.apiPost("/api/auth/setInstallUrl", { admin_code, app_install_url });
  $("outInstall").textContent = r.app_install_url;
  setMsg("ÄÃ£ lÆ°u link cÃ i app.");
  await loadPublic();
}

async function issue(type){
  setErr("");
  const admin_code = $("admin_code").value;
  const ttl_minutes = Number($("ttl").value||10) || 10;
  const r = await window.qrFactoryV3.apiPost("/api/auth/issue", { admin_code, type, ttl_minutes });
  $("outToken").textContent = r.token;
  $("outUrl").textContent = r.url;
  renderQrText("tokenBox", r.url);
}

document.addEventListener("DOMContentLoaded", ()=>{
  $("btnReload").onclick = ()=>loadPublic().catch(setErr);
  $("btnSetAdmin").onclick = ()=>setAdminCode().catch(setErr);
  $("btnSetUrl").onclick = ()=>setInstallUrl().catch(setErr);
  $("btnLogin").onclick = ()=>issue("login").catch(setErr);
  $("btnLogout").onclick = ()=>issue("logout").catch(setErr);
  loadPublic().catch(setErr);
});
</script>
<div class="issuer">VCRR Co.ltd</div>
</body></html>
